<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="wadsFp.css">
    <script type="text/javascript" src="bootstrap/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="bootstrap/css/bootstrap.min.css">
    <script type="text/javascript" src="bootstrap/js/bootstrap.min.js"></script>

    <title>fp</title>
    <script type="text/javascript" src="babylon.custom2.js"></script>
    <link rel="stylesheet" type="text/css" href="Canvas.css"/>
</head>
<body style="background-color: black;">

<canvas id="renderCanvas"></canvas>
<script>
    var canvas; 
    var scene; 
    var camera; 
    var ground;
    document.addEventListener("DOMContentLoaded", function() {
        //Get canvas
        canvas = document.getElementById("renderCanvas");
        
        //Create Babylon Engine
        engine = new BABYLON.Engine(canvas, true);

        //Create scene. Scene: Like a level in a game
        scene = new BABYLON.Scene(engine);

        // Camera
        var camera = new BABYLON.FreeCamera("camera1", new BABYLON.Vector3(5, 12, -125), scene);
        camera.setTarget(BABYLON.Vector3.Zero());
        camera.attachControl(canvas, true);
    
        // Light
        var light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);
    
        // Ground
        // var ground = BABYLON.Mesh.CreateGroundFromHeightMap("ground", "textures/dirt_01.png", 100, 100, 100, 0, 10, scene, false);
        ground = new BABYLON.Mesh.CreateGround("ground", 500, 500, 300, scene);
        var groundMaterial = new BABYLON.StandardMaterial("ground", scene);
        groundMaterial.diffuseTexture = new BABYLON.Texture("textures/TexturesCom_Grass0027_7_S.jpg", scene);
        groundMaterial.diffuseTexture.uScale = 6;
        groundMaterial.diffuseTexture.vScale = 6;
        groundMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
        ground.position.y = -2.05;
        ground.material = groundMaterial;


        var moon = BABYLON.Mesh.CreateSphere("boxCloud", 5, 11, scene);
        moon.position = new BABYLON.Vector3(0, 40, 90);

        var starMoonMaterial = new BABYLON.StandardMaterial("starMoonMat", scene);
        var starMoonProcText = new BABYLON.CloudProceduralTexture("starMoon", 1024, scene);
        starMoonMaterial.emissiveTexture = starMoonProcText;
        starMoonMaterial.backFaceCulling = false;
        starMoonMaterial.emissiveTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;

        moon.material = starMoonMaterial;
        moon.isVisible=false;

        ///////////////// INI2 //////////////////////////////

        // custom position function for SPS creation
        var starPositionFront = function(particle, i, s) {
            particle.position.x = Math.floor(Math.random() * (325 - (-350) + 1)) + (-350);
            particle.position.y = Math.floor(Math.random() * (200 - (0) + 1)) + (0);
            particle.position.z = 300;
        };

        var starPositionBack = function(particle, i, s) {
            particle.position.x = Math.floor(Math.random() * (325 - (-350) + 1)) + (-350);
            particle.position.y = Math.floor(Math.random() * (200 - (0) + 1)) + (0);
            particle.position.z = -300;
        };

        var starPositionLeft = function(particle, i, s) {
            particle.position.x = -300;
            particle.position.y = Math.floor(Math.random() * (200 - (0) + 1)) + (0);
            particle.position.z = Math.floor(Math.random() * (300 - (-200) + 1)) + (-200);
        };

        var starPositionRight = function(particle, i, s) {
            particle.position.x = 300;
            particle.position.y = Math.floor(Math.random() * (200 - (0) + 1)) + (0);
            particle.position.z = Math.floor(Math.random() * (300 - (-200) + 1)) + (-200);
        };

        var starPositionUp = function(particle, i, s) {
            particle.position.x = Math.floor(Math.random() * (325 - (-350) + 1)) + (-350);
            particle.position.y = 100;
            particle.position.z = Math.floor(Math.random() * (300 - (200) + 1)) + (200);
        };

        var starPosition = function(particle, i, s) {
            particle.position.x = Math.floor(Math.random() * (325 - (-350) + 1)) + (-350);
            particle.position.y = Math.floor(Math.random() * (200 - (0) + 1)) + (0);
            particle.position.z = Math.floor(Math.random() * (300 - (200) + 1)) + (200);
        };

        var starPosition2 = function(particle, i, s) {
            particle.position.x = 100;
            particle.position.y = -100;
            particle.position.z = 100;
        };

        
        var star = BABYLON.Mesh.CreateSphere("boxCloud", 6, 1, scene);
        star.material = starMoonMaterial;
  
        // SPS creation
        var SPS = new BABYLON.SolidParticleSystem('SPS', scene);
        SPS.addShape(star, 1000);
        var mesh = SPS.buildMesh();
        // dispose the model
        star.dispose();

        ////////////////////////////////////////////////////////////////////

        // Sky material
        var skyboxMaterial = new BABYLON.SkyMaterial("skyMaterial", scene);
        skyboxMaterial.backFaceCulling = false;
        //skyboxMaterial._cachedDefines.FOG = true;

        // Sky mesh (box)
        var skybox = BABYLON.Mesh.CreateBox("skyBox", 1000.0, scene);
        skybox.position = new BABYLON.Vector3(0, 75, 0);
        skybox.material = skyboxMaterial;


        var skybox2 = BABYLON.Mesh.CreatePlane("sky", 1000.0, scene);
        skybox2.position = new BABYLON.Vector3(0, 50, 0);
        skybox2.isVisible=false;
    
        var setSkyConfig = function (property, from, to) {
            var keys = [
                { 
                    frame: 0, 
                    value: from 
                },
                { 
                    frame: 5, 
                    value: to 
                }
            ];
        
            var animation = new BABYLON.Animation("animation", property, 5, BABYLON.Animation.ANIMATIONTYPE_FLOAT, BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);
            animation.setKeys(keys);
        
            //scene.stopAnimation(skybox);
            scene.beginDirectAnimation(skybox, [animation], 0, 100, true);
        };
    

        // Set to Day
        setSkyConfig("material.inclination", skyboxMaterial.inclination, -0.2);

       // var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");

       // MODEL //

        var walls = BABYLON.Mesh.CreateBox("walls", 20, scene);
        walls.position = new BABYLON.Vector3(82, 10, 38);
        walls.scaling.x=0.7;
        walls.scaling.y=2.1;
        walls.scaling.z=0.3;

        var wallsMaterial = new BABYLON.StandardMaterial("wallsMaterial", scene);
        wallsMaterial.diffuseTexture = new BABYLON.Texture("textures/brick.jpg", scene);
        walls.material = wallsMaterial;

        //robotMain.position.y = 3;
        //robotMain.physicsImpostor = new BABYLON.PhysicsImpostor(robotMain, BABYLON.PhysicsImpostor.BoxImpostor, {mass: 1, restitution: 0.5, friction: 0.2}, scene);

        var speed=0.01;
        var siren = new BABYLON.Mesh.CreateBox("siren", 1.0, scene);
        siren.actionManager = new BABYLON.ActionManager(scene);

        siren.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPickUpTrigger, function () {
            if(speed<0.1)
                speed=speed+0.02;
            else
                speed=0.01;
        }));

        BABYLON.SceneLoader.ImportMesh("", "rotor/", "Rotor8_fixed.stl", scene, function(newMeshes){
            for(i = 0; i < newMeshes.length; i++){
                newMeshes[i].parent = siren;
                siren.position.z=25;
                siren.position.y=30;
                siren.position.x=80;
                siren.rotation.x = 1.57;

                siren.scaling.x=siren.scaling.x-0.3;
                siren.scaling.y=siren.scaling.y-0.3;
                siren.scaling.z=siren.scaling.z-0.3;
                //robotMain.scaling.y=10;
            }
        });

        var bridge = new BABYLON.Mesh.CreateBox("bridge", 1.0, scene);
        bridge.isVisible=false;
        bridge.actionManager = new BABYLON.ActionManager(scene);

        BABYLON.SceneLoader.ImportMesh("", "bridge/", "bridge2.babylon", scene, function(newMeshes){
            for(i = 0; i < newMeshes.length; i++){
                /*newMeshes[i].position.z=newMeshes[i].position.z+5;
                newMeshes[i].position.y=newMeshes[i].position.y+5;
                newMeshes[i].position.x=newMeshes[i].position.x-15;
                newMeshes[i].rotation.y = 3;
                newMeshes[i].scaling.x=newMeshes[i].scaling.x+1;
                newMeshes[i].scaling.y=newMeshes[i].scaling.y+1;
                newMeshes[i].scaling.z=newMeshes[i].scaling.z+1;*/

                newMeshes[i].parent = bridge;
                bridge.position.z=12;
                bridge.position.y=5;
                bridge.position.x=-15;
                bridge.rotation.y = Math.PI/2;

                bridge.scaling.x=bridge.scaling.x+0.9;
                bridge.scaling.y=bridge.scaling.y+0.9;
                bridge.scaling.z=bridge.scaling.z+0.9;
                
            }
        });

        var tree = new BABYLON.Mesh.CreateBox("tree", 1.0, scene);
        //bridge.isVisible=false;
        tree.actionManager = new BABYLON.ActionManager(scene);

        BABYLON.SceneLoader.ImportMesh("", "tree/", "tree.babylon", scene, function(newMeshes){
            for(i = 0; i < newMeshes.length; i++){
                newMeshes[i].parent = tree;
                // tree.position.z=12;
                // tree.position.y=5;
                // tree.position.x=-15;
                // tree.rotation.y = Math.PI/2;

                // tree.scaling.x=tree.scaling.x+0.9;
                // tree.scaling.y=tree.scaling.y+0.9;
                // tree.scaling.z=tree.scaling.z+0.9;
                
            }
        });
        var treeFall = function (property, from, to) {
            var keys = [
                { 
                    frame: 0, 
                    value: from 
                },
                { 
                    frame: 5, 
                    value: to 
                }
            ];
        
            var animation = new BABYLON.Animation("animation", property, 5, BABYLON.Animation.ANIMATIONTYPE_FLOAT, BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);
            animation.setKeys(keys);
        
            scene.beginDirectAnimation(tree, [animation], 0, 100, true);
        };
        
        tree.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPickUpTrigger, function () {
            treeFall("rotation.z", tree.rotation.z, -(Math.PI/2));
        }));

               

       // Water
        var river = BABYLON.Mesh.CreatePlane("test", 100, scene); 
        river.rotation.x = Math.PI/2;
        //waterMesh1.rotation.x += Math.PI/2;

    
        var water = new BABYLON.WaterMaterial("water", scene/*, new BABYLON.Vector2(1024, 1024)*/);
        water.backFaceCulling = true;
        water.bumpTexture = new BABYLON.Texture("textures/water4.jpg", scene);
        water.windForce = -3; // arus nya kencengin disini /Represents the wind force applied on the water surface
        water.waveHeight = 0.1;// Represents the height of the waves
        water.bumpHeight = 2; 
        water.waveLength = 0.5;

        river.scaling.y=0.7; // ukuran lebar
        river.scaling.x=4.3; // ukuran panjang
        river.position.z = -30; //deket jauhnya ke dpan belakang (kalo mo jauhan/deketan ke camera)
        //waterMesh1.alpha=0.5;
        water.colorBlendFactor = 0;
        water.windDirection = new BABYLON.Vector2(-0.8, 0.4);// atur arah arus bisa disini

        water.addToRenderList(skybox);
        water.addToRenderList(ground);
        water.addToRenderList(moon);
        water.addToRenderList(siren);
        water.addToRenderList(walls);
        water.addToRenderList(bridge);
    
        river.material = water;
        //////////////////////
        ///////////////////////////
        // Create a particle system
        var particleSystem = new BABYLON.ParticleSystem("particles", 25000, scene);

        //Texture of each particle
        particleSystem.particleTexture = new BABYLON.Texture("textures/flare.png", scene);

        // Where the particles come from
        particleSystem.emitter = skybox2; // the starting object, the emitter
        particleSystem.minEmitBox = new BABYLON.Vector3(-200, 0, -250); // Starting all from
        particleSystem.maxEmitBox = new BABYLON.Vector3(200, 0, 75); // To...

        // Size of each particle (random between...
        particleSystem.minSize = 0.5;
        particleSystem.maxSize = 0.8;

        // Life time of each particle (random between...
        particleSystem.minLifeTime = 4;
        particleSystem.maxLifeTime = 15;

        // Emission rate
        particleSystem.emitRate = 15000;

        // Blend mode : BLENDMODE_ONEONE, or BLENDMODE_STANDARD
        particleSystem.blendMode = BABYLON.ParticleSystem.BLENDMODE_ONEONE;

        // Set the gravity of all particles
        particleSystem.gravity = new BABYLON.Vector3(0, -9.81, 0);

        // Direction of each particle after it has been emitted
        particleSystem.direction1 = new BABYLON.Vector3(-7, -8, 3);
        particleSystem.direction2 = new BABYLON.Vector3(7, -8, -3);

        // Speed
        particleSystem.minEmitPower = 1;
        particleSystem.maxEmitPower = 3;
        particleSystem.updateSpeed = 0.005;
        ////////////////////////////

        var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");

        ////////////////////
        var snowMaxSpeedpanel = new BABYLON.GUI.StackPanel();
        snowMaxSpeedpanel.width = "220px";
        snowMaxSpeedpanel.top = "-27%";
        snowMaxSpeedpanel.left = "-40%";
        advancedTexture.addControl(snowMaxSpeedpanel);

        var snowMaxSpeedheader = new BABYLON.GUI.TextBlock();
        snowMaxSpeedheader.text = "snow max speed: " +particleSystem.maxEmitPower;
        snowMaxSpeedheader.height = "30px";
        snowMaxSpeedheader.color = "white";
        snowMaxSpeedpanel.addControl(snowMaxSpeedheader); 

        var snowMaxSpeedslider = new BABYLON.GUI.Slider();
        snowMaxSpeedslider.minimum = 1;
        snowMaxSpeedslider.maximum = 50;
        snowMaxSpeedslider.value = 0;
        snowMaxSpeedslider.height = "15px";
        snowMaxSpeedslider.width = "150px";
        snowMaxSpeedslider.onValueChangedObservable.add(function(value) {
            snowMaxSpeedheader.text = "snow max speed: " + Math.round(value) ;
        });
        snowMaxSpeedpanel.addControl(snowMaxSpeedslider);
        ////////////////
        var snowEmitRatepanel = new BABYLON.GUI.StackPanel();
        snowEmitRatepanel.width = "220px";
        snowEmitRatepanel.top = "-37%";
        snowEmitRatepanel.left = "-40%";
        advancedTexture.addControl(snowEmitRatepanel);

        var snowEmitRateheader = new BABYLON.GUI.TextBlock();
        snowEmitRateheader.text = "snow emit rate: " +particleSystem.emitRate;
        snowEmitRateheader.height = "30px";
        snowEmitRateheader.color = "white";
        snowEmitRatepanel.addControl(snowEmitRateheader); 

        var snowEmitRateslider = new BABYLON.GUI.Slider();
        snowEmitRateslider.minimum = 1000;
        snowEmitRateslider.maximum = 50000;
        snowEmitRateslider.value = 0;
        snowEmitRateslider.height = "15px";
        snowEmitRateslider.width = "150px";
        snowEmitRateslider.onValueChangedObservable.add(function(value) {
            snowEmitRateheader.text = "snow emit rate: " + Math.round(value) ;
        });
        snowEmitRatepanel.addControl(snowEmitRateslider);
        ///////////////////

        var timerBackground = new BABYLON.GUI.Rectangle();
        timerBackground.width = 0.2;
        timerBackground.height = "40px";
        timerBackground.cornerRadius = 20;
        timerBackground.color = "white";
        timerBackground.thickness = 4;
        timerBackground.background = "green";
        advancedTexture.addControl(timerBackground);

        var label = new BABYLON.GUI.TextBlock();
        label.text = "10";
        timerBackground.addControl(label);

        timerBackground.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT;
        timerBackground.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;

        var buttonDaytime = BABYLON.GUI.Button.CreateSimpleButton("buttonDaytime", "daytime");
        buttonDaytime.width = 0.08;
        buttonDaytime.height = 0.05;
        buttonDaytime.top = "-45%";
        buttonDaytime.left = "-44%";
        buttonDaytime.color = "white";
        buttonDaytime.fontSize = 16;
        buttonDaytime.background = "green";
        //var buttonEvt;
        buttonDaytime.onPointerUpObservable.add(function () {
            //SPS.dispose();
            moon.isVisible=false; 
            water.bumpHeight = 2; 
            setSkyConfig("material.inclination", skyboxMaterial.inclination, -0.3);
            /////////////////////////// INI2 /////////////////
            SPS.initParticles = function () {
                for (var p = 0; p < SPS.nbParticles; p++) {
                    starPosition2(SPS.particles[p]);
                }
            }
            SPS.initParticles();
            SPS.setParticles();
        });
        advancedTexture.addControl(buttonDaytime);

        var buttonSunset = BABYLON.GUI.Button.CreateSimpleButton("buttonSunset", "sunset");
        buttonSunset.width = 0.08;
        buttonSunset.height = 0.05;
        buttonSunset.top = "-45%";
        buttonSunset.left = "-35%";
        buttonSunset.color = "white";
        buttonSunset.fontSize = 16;
        buttonSunset.background = "green";
        //var buttonEvt;
        buttonSunset.onPointerUpObservable.add(function () {
            water.bumpHeight = 0.5; 
            setSkyConfig("material.inclination", skyboxMaterial.inclination, -0.5);
            moon.isVisible=false;
            //////////////////////////// INI2 //////////////////
            SPS.initParticles = function () {
                for (var p = 0; p < SPS.nbParticles; p++) {
                    starPosition2(SPS.particles[p]);
                }
            }
            SPS.initParticles();
            SPS.setParticles();
           // SPS.dispose();
        });
        advancedTexture.addControl(buttonSunset);


        var buttonNight = BABYLON.GUI.Button.CreateSimpleButton("buttonNight", "night");
        buttonNight.width = 0.08;
        buttonNight.height = 0.05;
        buttonNight.top = "-45%";
        buttonNight.left = "-8%";
        buttonNight.color = "white";
        buttonNight.fontSize = 16;
        buttonNight.background = "green";
 
        buttonNight.onPointerUpObservable.add(function () {
            water.bumpHeight = 0.5; 
            setSkyConfig("material.inclination", skyboxMaterial.inclination, -0.7);

            window.setTimeout(function () {
                moon.isVisible=true;
                ////////////////////// INI2//////////////////
                SPS.initParticles = function () {
                    for (var p = 0; p < SPS.nbParticles; p++) {
                        var rand = Math.floor(Math.random() * (5 - (1) + 1)) + (1);

                        if(rand==1)
                            starPositionFront(SPS.particles[p]);
                        else if(rand==2)
                            starPositionBack(SPS.particles[p]);
                        else if(rand==3)
                            starPositionLeft(SPS.particles[p]);
                        else if(rand==4)
                            starPositionRight(SPS.particles[p]);
                        else if(rand==5)
                            starPositionUp(SPS.particles[p]);
                    }
                }
                SPS.initParticles();
                SPS.setParticles();
            }, 900);
        });
        advancedTexture.addControl(buttonNight);


        var buttonRain = BABYLON.GUI.Button.CreateSimpleButton("buttonRain", "rain");
        buttonRain.width = 0.08;
        buttonRain.height = 0.05;
        buttonRain.top = "-45%";
        buttonRain.left = "-26%";
        buttonRain.color = "white";
        buttonRain.fontSize = 16;
        buttonRain.background = "green";
        //var buttonEvt;
        buttonRain.onPointerUpObservable.add(function () {
            var postProcess = new BABYLON.DigitalRainPostProcess("DigitalRain", camera, 
            {
                font: "3px Monospace",
                mixToNormal: 0.5,
                mixToTile: 0.5        
            });
            var timeleft = 10;

            var downloadTimer = setInterval(function(){
                timeleft--;
                var n = timeleft.toString();
                label.text = n;
                if(timeleft <= 0){
                    label.text = "10";
                    clearInterval(downloadTimer);
                    timeleft = 10;
                }
            },1000);
        //postProcess.setVisible=false;
            window.setTimeout(function () {
                scene.registerBeforeRender(function() {
                    postProcess.mixToNormal = 1; 
                });
            }, 10000);
        });
        advancedTexture.addControl(buttonRain);

        var buttonSnow = BABYLON.GUI.Button.CreateSimpleButton("buttonSnow", "snow");
        buttonSnow.width = 0.08;
        buttonSnow.height = 0.05;
        buttonSnow.top = "-45%";
        buttonSnow.left = "-17%";
        buttonSnow.color = "white";
        buttonSnow.fontSize = 16;
        buttonSnow.background = "green";
        //var buttonEvt;
        buttonSnow.onPointerUpObservable.add(function () {
        
            // Start the particle system
            particleSystem.start();

            snowMaxSpeedslider.onValueChangedObservable.add(function(value) {
                snowMaxSpeedheader.text = "snow max speed: " + Math.round(value);
                particleSystem.maxEmitPower = value;
            });
            snowEmitRateslider.onValueChangedObservable.add(function(value) {
                snowEmitRateheader.text = "snow emit rate: " + Math.round(value) ;
                particleSystem.emitRate = value;
            });

            // var timeleft = 10;

            // var downloadTimer = setInterval(function(){
            //     timeleft--;
            //     var n = timeleft.toString();
            //     label.text = n;
            //     if(timeleft <= 0){
            //         label.text = "10";
            //         clearInterval(downloadTimer);
            //         timeleft = 10;
            //     }
            // },1000);

            // window.setTimeout(function () {
            //     groundMaterial.diffuseTexture = new BABYLON.Texture("textures/snow.jpg", scene);
            //     groundMaterial.alpha = 0.4;
            //     particleSystem.stop();
            // }, 10000);
        });
        advancedTexture.addControl(buttonSnow);


        engine.runRenderLoop(function(){
            siren.rotate(BABYLON.Axis.Y, speed, BABYLON.Space.LOCAL);
           // camera.rotation.y = 0;
            //tree.rotation.x = Math.PI/2;
            //tree.rotation.z= -(Math.PI/2);
            scene.render();
        });


    });

</script>

</body>
</html>